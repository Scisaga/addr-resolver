# 地址智能解析服务 (AddrResolver)

结合高德地图 API、通义千问大语言模型与本地私有地址库，AddrResolver 可将自然语言地址智能解析为结构化地理信息，提供地图定位、地址匹配与标准化 API 服务。

系统针对中国复杂多样的地址表达习惯进行优化，支持地名不规范、模糊描述（如“对面”“门口”“往南100米”）的高精度识别，广泛适用于园区、厂区、城乡结合部等非标准场景。

作为智能规划引擎与调度系统的前置模块，AddrResolver 为物流配送、上门服务、客服派单等关键流程提供高质量的地址识别基础，为实体产业引入可计算的空间智能能力，推动AI智能化调度体系升级。

## ⚙️ 主要功能

- **智能地址解析**: 将自然语言地址解析为结构化字段（城市、区县、兴趣点、门牌号等）
- **多源数据融合**: 结合高德地图API、通义千问模型和私有地址库，提供高精度的地址匹配
- **私有地址库管理**：支持私有地址的增删查改与地图选点，适配企业园区、工厂等内部场景
- **交互式Web界面**: 提供可视化的地址输入与结构化结果展示界面
- **标准化 API 服务**: RESTful API 支持地址解析、私有地址库操作、周边匹配等调用
- **地图可视化定位**: 集成高德地图，直观展示 POI 匹配结果与空间信息
- **Docker部署**: 支持一键部署为微服务组件，便于集成到企业系统中

## 🏗️ 系统架构

```
AddrResolver/
├── .env                   # 环境变量配置文件
├── app.py                 # Flask Web应用主文件
├── address_resolver.py    # 核心地址解析逻辑
├── address_db.py          # 私有地址库数据库操作
├── address_db_build.py    # 私有地址库初始化脚本
├── similarity.py          # 相似度计算模块
├── struct_prompt.md       # 大模型提示词模板
├── templates/
│ ├── index.html # 地址解析界面
│ └── address.html # 私有地址库管理界面
├── requirements.txt       # Python依赖包
├── Dockerfile             # Docker镜像构建文件
├── docker-compose.yml     # Docker Compose配置
└── logs/                  # 日志目录
```

## 🗂️ 私有地址库功能与管理

系统支持本地私有地址库，并提供界面 `/address` 用于交互式管理：

- **地图选点**：鼠标点击地图获取经纬度，无需手动输入
- **字段校验**：确保名称、地址、经纬度等为必填项
- **关键词搜索与时间筛选**：支持 FTS5 模糊搜索与按更新时间过滤
- **分页浏览与一键删除**
- **自动更新时间戳与搜索排序**

数据库设计支持全文索引（FTS5）与经纬度范围查找，适用于快速定位和解析匹配。

## 🧠 智能解析整体逻辑

### 1. 私有地址库匹配（优先级最高）
- 使用 FTS5 模糊匹配名称或地址
- 匹配成功即返回，不调用外部 API

### 2. 快速匹配（Amap POI Search）
- 使用高德搜索 API 快速查找地址匹配项
- 相似度 ≥70 分则直接命中返回

### 3. 地址结构化处理
系统首先使用通义千问大语言模型将自然语言地址解析为6个结构化字段：

| 字段 | 说明 | 示例 |
|------|------|------|
| **C** | 直辖市、地级市（删除省一级信息） | "宁波市" |
| **D** | 区县 + 街道/镇，不包含道路信息 | "慈溪市长河镇" |
| **AP** | 兴趣点/小区/社区/道路/研究所 + 楼名/楼宇编号 | "云海村南3号" |
| **U** | 单元、门牌、楼栋、房号等内部位置信息 | "1单元201室" |
| **I** | 辅助信息（如"附近"、"对面"、"门口"等） | "北门附近" |
| **T** | 该地址所属的类型 | "商务住宅" |

### 4. 多阶段POI搜索策略

#### 阶段1：精确搜索
- 使用 `D + AP` 字段组合作为搜索关键词
- 调用**高德输入提示API**进行精确匹配
- 如果结果少于3个，则使用 `AP` 字段单独搜索

#### 阶段2：周边搜索（Fallback）
当精确搜索无结果时，系统启动周边搜索：
1. **锚点定位**: 使用**高德地理编码API**，优先使用 `AP` 字段，失败则使用 `D` 字段
2. **关键词提取**: 从 `U`、`AP`、`I` 字段中提取搜索关键词
3. **周边搜索**: 调用**高德周边搜索API**，以锚点为中心，使用提取的关键词搜索周边POI
4. **大模型辅助**: 当存在辅助信息（`I`字段）时，调用通义千问判断各候选POI的匹配程度

### 5. 智能匹配算法

#### 相似度计算
系统使用多维度相似度计算：
- **文本相似度** (70%权重): 基于分词和关键词重叠率
- **空间辅助得分** (30%权重): 基于大模型对辅助信息的理解

#### 最终评分公式
```
最终得分 = 0.7 × 文本相似度 + 0.3 × 空间辅助得分
```

### 6. 结果优化
- 自动去重：基于POI ID合并搜索结果
- 逆地理编码：使用**高德逆地理编码API**补充乡镇街道等详细信息
- 性能监控：记录处理耗时

### 7. 返回字段说明

系统返回的JSON对象包含以下字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | string | POI的唯一标识符 |
| `name` | string | POI名称 |
| `address` | string | POI详细地址 |
| `location` | string | 经纬度坐标（经度,纬度） |
| `regeo` | object | 逆地理编码信息（乡镇街道等） |
| `similarity` | float | 文本相似度得分（0-100） |
| `auxiliary` | float | 空间辅助得分（0-100） |
| `score` | float | 最终匹配得分（0-100） |
| `duration` | float | 处理耗时（秒） |

### 8. 高德地图API集成

系统集成了以下5个高德地图API接口：

| API接口              | 接口地址                  | 主要功能                         | 使用场景                                             |
|----------------------|---------------------------|----------------------------------|------------------------------------------------------|
| **输入提示 API**     | `/v3/assistant/inputtips` | 模糊搜索 POI，支持城市限定       | 精确搜索阶段，使用 D+AP 字段组合搜索                |
| **地理编码 API**     | `/v3/geocode/geo`         | 将地址文本转换为经纬度坐标       | 周边搜索的锚点定位                                   |
| **逆地理编码 API**   | `/v3/geocode/regeo`       | 将经纬度坐标转换为详细地址信息   | 补充 POI 的乡镇街道等详细信息                        |
| **周边搜索 API**     | `/v3/place/around`        | 以指定坐标为中心搜索周边 POI     | Fallback 阶段，当精确搜索无结果时使用               |
| **POI 关键词查询 API** | `/v3/place/text`           | 根据关键词在指定城市搜索 POI     | 快速匹配阶段：高性能、支持类型过滤、优先返回准确匹配 |


## 🚀 快速开始

### 环境要求

- Python 3.8+
- Docker (可选，用于容器化部署)

### 1. 克隆项目

```bash
git clone <repository-url>
cd AddrResolver
```

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 配置API密钥

创建`.env`，配置API密钥等信息：

```env
AMAP_KEY=高德地图API密钥
LLM_API_KEY=阿里云百炼API密钥
QWEN_MODEL=qwen3-32b
```

**获取API密钥：**
- [高德地图开放平台](https://lbs.amap.com/) - 获取高德API密钥
- [阿里云百炼](https://bailian.console.aliyun.com/) - 获取通义千问API密钥

### 4. 运行应用

```bash
# 初始化数据库
python address_db_build.py
# 运行
python app.py
```

访问 http://localhost:5000 即可使用Web界面。

### 5. API调用
- [OpenAPI文档](./static/swagger/openapi.yaml)
- 打开浏览器访问 http://localhost:5000/docs

## 🐳 Docker部署

### 构建镜像

```bash
docker build -t scisaga/addr-resolver:latest .
```

### 推送镜像（可选）

```bash
docker push scisaga/addr-resolver:latest
```

### 使用Docker Compose部署

1. 设置环境变量（创建 `.env` 文件）
2. 启动服务 `docker compose up -d --pull always`

## 🤝 贡献

欢迎提交Issue和Pull Request来改进这个项目。

## 📄 许可证

本项目采用MIT许可证。

## 🔗 相关链接

- [高德地图开放平台](https://lbs.amap.com/)
- [阿里云百炼](https://bailian.console.aliyun.com/)
- [Flask框架](https://flask.palletsprojects.com/)
- [通义千问](https://qianwen.aliyun.com/)